open import common
import syntactics
import reduction

module typing
  (Level : Set)
  (_<_ : Level â†’ Level â†’ Set)
  (trans< : âˆ€ {i j k} â†’ i < j â†’ j < k â†’ i < k) where
open syntactics Level
open reduction Level

data _â‰¤_ : Level â†’ Level â†’ Set where
  eq : âˆ€ {k} â†’ k â‰¤ k
  lt : âˆ€ {j k} â†’ j < k â†’ j â‰¤ k

{------------------------
  Definitional equality
------------------------}

data _â‰ˆ_ : Term â†’ Term â†’ Set where
  â‰ˆ-refl  : âˆ€ {a} â†’ a â‰ˆ a
  â‰ˆ-sym   : âˆ€ {a b} â†’
            b â‰ˆ a â†’
            ---------
            a â‰ˆ b
  â‰ˆ-trans : âˆ€ {a b c} â†’
            a â‰ˆ b â†’
            b â‰ˆ c â†’
            -----------
            a â‰ˆ c
  â‰ˆ-Î²     : âˆ€ {b a} â†’
            --------------------------------
            $áµˆ (Î»áµˆ b) a â‰ˆ subst (a +: var) b
  â‰ˆ-Î      : âˆ€ {a a' b b'} â†’
            a â‰ˆ a' â†’
            b â‰ˆ b' â†’
            -------------------
            Î  a b â‰ˆ Î  a' b'
  â‰ˆ-Î»áµˆ    : âˆ€ {b b'} â†’
            b â‰ˆ b' â†’
            ------------
            Î»áµˆ b â‰ˆ Î»áµˆ b'
  â‰ˆ-$áµˆ    : âˆ€ {b b' a a'} â†’
            b â‰ˆ b' â†’
            a â‰ˆ a' â†’
            -----------------
            $áµˆ b a â‰ˆ $áµˆ b' a'
  â‰ˆ-abs   : âˆ€ {b b'} â†’
            b â‰ˆ b' â†’
            --------------
            abs b â‰ˆ abs b'

-- Conversion is sound and complete with respect to definitional equality,
-- making conversion an appropriate implementation of definitional equality

â‡’-â‰ˆ : âˆ€ {a b} â†’ a â‡’ b â†’ a â‰ˆ b
â‡’-â‰ˆ (â‡’-Î² bâ‡’b' aâ‡’a') = â‰ˆ-trans (â‰ˆ-$áµˆ (â‰ˆ-Î»áµˆ (â‡’-â‰ˆ bâ‡’b')) (â‡’-â‰ˆ aâ‡’a')) â‰ˆ-Î²
â‡’-â‰ˆ (â‡’-var s) = â‰ˆ-refl
â‡’-â‰ˆ (â‡’-ð’° k) = â‰ˆ-refl
â‡’-â‰ˆ (â‡’-Î  aâ‡’a' bâ‡’b') = â‰ˆ-Î  (â‡’-â‰ˆ aâ‡’a') (â‡’-â‰ˆ bâ‡’b')
â‡’-â‰ˆ (â‡’-Î»áµˆ bâ‡’b') = â‰ˆ-Î»áµˆ (â‡’-â‰ˆ bâ‡’b')
â‡’-â‰ˆ (â‡’-$áµˆ bâ‡’b' aâ‡’a') = â‰ˆ-$áµˆ (â‡’-â‰ˆ bâ‡’b') (â‡’-â‰ˆ aâ‡’a')
â‡’-â‰ˆ â‡’-mty = â‰ˆ-refl
â‡’-â‰ˆ (â‡’-abs bâ‡’b') = â‰ˆ-abs (â‡’-â‰ˆ bâ‡’b')

â‡’â‹†-â‰ˆ : âˆ€ {a b} â†’ a â‡’â‹† b â†’ a â‰ˆ b
â‡’â‹†-â‰ˆ (â‡’â‹†-refl a) = â‰ˆ-refl
â‡’â‹†-â‰ˆ (â‡’â‹†-trans aâ‡’b bâ‡’â‹†c) = â‰ˆ-trans (â‡’-â‰ˆ aâ‡’b) (â‡’â‹†-â‰ˆ bâ‡’â‹†c)

â‡”-â‰ˆ : âˆ€ {a b} â†’ a â‡” b â†’ a â‰ˆ b
â‡”-â‰ˆ (_ , aâ‡’â‹†c , bâ‡’â‹†c) = â‰ˆ-trans (â‡’â‹†-â‰ˆ aâ‡’â‹†c) (â‰ˆ-sym (â‡’â‹†-â‰ˆ bâ‡’â‹†c))

â‰ˆ-â‡” : âˆ€ {a b} â†’ a â‰ˆ b â†’ a â‡” b
â‰ˆ-â‡” â‰ˆ-refl = â‡”-refl
â‰ˆ-â‡” (â‰ˆ-sym bâ‰ˆa) = â‡”-sym (â‰ˆ-â‡” bâ‰ˆa)
â‰ˆ-â‡” (â‰ˆ-trans aâ‰ˆb bâ‰ˆc) = â‡”-trans (â‰ˆ-â‡” aâ‰ˆb) (â‰ˆ-â‡” bâ‰ˆc)
â‰ˆ-â‡” â‰ˆ-Î² = â‡’-â‡” (â‡’-Î² (â‡’-refl _) (â‡’-refl _))
â‰ˆ-â‡” (â‰ˆ-Î  aâ‰ˆa' bâ‰ˆb') = â‡”-Î  (â‰ˆ-â‡” aâ‰ˆa') (â‰ˆ-â‡” bâ‰ˆb')
â‰ˆ-â‡” (â‰ˆ-Î»áµˆ bâ‰ˆb') = â‡”-Î»áµˆ (â‰ˆ-â‡” bâ‰ˆb')
â‰ˆ-â‡” (â‰ˆ-$áµˆ bâ‰ˆb' aâ‰ˆa') = â‡”-$áµˆ (â‰ˆ-â‡” bâ‰ˆb') (â‰ˆ-â‡” aâ‰ˆa')
â‰ˆ-â‡” (â‰ˆ-abs bâ‰ˆb') = â‡”-abs (â‰ˆ-â‡” bâ‰ˆb')

{--------------------------------------------------
  Context well-formedness and term well-typedness
--------------------------------------------------}

infix 10 âŠ¢_
data âŠ¢_ : Ctxt â†’ Set
data _âŠ¢_â¦‚_ (Î“ : Ctxt) : Term â†’ Term â†’ Set

data âŠ¢_ where
  âŠ¢âˆ™ : âŠ¢ âˆ™
  âŠ¢âˆ· : âˆ€ {Î“ A k} â†’
       âŠ¢ Î“ â†’
       Î“ âŠ¢ A â¦‚ ð’° k â†’
       ---------------
       âŠ¢ Î“ âˆ· A

data _âŠ¢_â¦‚_ Î“ where
  âŠ¢var : âˆ€ {x A} â†’
         âŠ¢ Î“ â†’
         x â¦‚ A âˆˆ Î“ â†’
         -------------
         Î“ âŠ¢ var x â¦‚ A
  âŠ¢ð’°   : âˆ€ {j k} â†’ âŠ¢ Î“ â†’
         j < k â†’
         ---------------
         Î“ âŠ¢ ð’° j â¦‚ ð’° k
  âŠ¢Î    : âˆ€ {A B k} â†’
         Î“ âŠ¢ A â¦‚ ð’° k â†’
         Î“ âˆ· A âŠ¢ B â¦‚ ð’° k â†’
         -----------------
         Î“ âŠ¢ Î  A B â¦‚ ð’° k
  âŠ¢Î»áµˆ  : âˆ€ {A B b k} â†’
         Î“ âŠ¢ Î  A B â¦‚ ð’° k â†’
         Î“ âˆ· A âŠ¢ b â¦‚ B â†’
         ----------------
         Î“ âŠ¢ Î»áµˆ b â¦‚ Î  A B
  âŠ¢$áµˆ  : âˆ€ {A B b a} â†’
         Î“ âŠ¢ b â¦‚ Î  A B â†’
         Î“ âŠ¢ a â¦‚ A â†’
         -------------------------------
         Î“ âŠ¢ $áµˆ b a â¦‚ subst (a +: var) B
  âŠ¢mty : âˆ€ {k} â†’ âŠ¢ Î“ â†’
         ---------------
         Î“ âŠ¢ mty â¦‚ ð’° k
  âŠ¢abs : âˆ€ {A b k} â†’
         Î“ âŠ¢ A â¦‚ ð’° k â†’
         Î“ âŠ¢ b â¦‚ mty â†’
         -------------
         Î“ âŠ¢ abs b â¦‚ A
  âŠ¢â‰ˆ   : âˆ€ {A B a k} â†’
         A â‰ˆ B â†’
         Î“ âŠ¢ a â¦‚ A â†’
         Î“ âŠ¢ B â¦‚ ð’° k â†’
         -------------
         Î“ âŠ¢ a â¦‚ B