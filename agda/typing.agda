open import common
import syntactics
import reduction

module typing
  (Level : Set)
  (_<_ : Level â†’ Level â†’ Set)
  (trans< : âˆ€ {i j k} â†’ i < j â†’ j < k â†’ i < k) where
open syntactics Level
open reduction Level

data _â‰¤_ : Level â†’ Level â†’ Set where
  eq : âˆ€ {k} â†’ k â‰¤ k
  lt : âˆ€ {j k} â†’ j < k â†’ j â‰¤ k

{------------------------
  Definitional equality
------------------------}

data _â‰ˆ_ : Term â†’ Term â†’ Set where
  â‰ˆ-refl  : âˆ€ {a} â†’ a â‰ˆ a
  â‰ˆ-sym   : âˆ€ {a b} â†’
            b â‰ˆ a â†’
            ---------
            a â‰ˆ b
  â‰ˆ-trans : âˆ€ {a b c} â†’
            a â‰ˆ b â†’
            b â‰ˆ c â†’
            -----------
            a â‰ˆ c
  â‰ˆ-Î²     : âˆ€ {b a} â†’
            --------------------------------
            $áµˆ (Î»áµˆ b) a â‰ˆ subst (a +: var) b
  â‰ˆ-Î¹     : âˆ€ {d} â†’
            ------------
            J d refl â‰ˆ d
  â‰ˆ-ift   : âˆ€ {a c} â†’
            ----------------
            if true a c â‰ˆ a
  â‰ˆ-iff   : âˆ€ {a c} â†’
            ----------------
            if false a c â‰ˆ c
  â‰ˆ-Î      : âˆ€ {a a' b b'} â†’
            a â‰ˆ a' â†’
            b â‰ˆ b' â†’
            ---------------
            Î  a b â‰ˆ Î  a' b'
  â‰ˆ-Î»áµˆ    : âˆ€ {b b'} â†’
            b â‰ˆ b' â†’
            ------------
            Î»áµˆ b â‰ˆ Î»áµˆ b'
  â‰ˆ-$áµˆ    : âˆ€ {b b' a a'} â†’
            b â‰ˆ b' â†’
            a â‰ˆ a' â†’
            -----------------
            $áµˆ b a â‰ˆ $áµˆ b' a'
  â‰ˆ-abs   : âˆ€ {b b'} â†’
            b â‰ˆ b' â†’
            --------------
            abs b â‰ˆ abs b'
  â‰ˆ-eq    : âˆ€ {A A' a a' b b'} â†’
            A â‰ˆ A' â†’
            a â‰ˆ a' â†’
            b â‰ˆ b' â†’
            ----------------------
            eq A a b â‰ˆ eq A' a' b'
  â‰ˆ-J     : âˆ€ {d d' p p'} â†’
            d â‰ˆ d' â†’
            p â‰ˆ p' â†’
            ---------------
            J d p â‰ˆ J d' p'
  â‰ˆ-if    : âˆ€ {b b' a a' c c'} â†’
            b â‰ˆ b' â†’
            a â‰ˆ a' â†’
            c â‰ˆ c' â†’
            ----------------------
            if b a c â‰ˆ if b' a' c'

-- Conversion is sound and complete with respect to definitional equality,
-- making conversion an appropriate implementation of definitional equality

â‡’-â‰ˆ : âˆ€ {a b} â†’ a â‡’ b â†’ a â‰ˆ b
â‡’-â‰ˆ (â‡’-Î² bâ‡’b' aâ‡’a') = â‰ˆ-trans (â‰ˆ-$áµˆ (â‰ˆ-Î»áµˆ (â‡’-â‰ˆ bâ‡’b')) (â‡’-â‰ˆ aâ‡’a')) â‰ˆ-Î²
â‡’-â‰ˆ (â‡’-Î¹ dâ‡’d') = â‰ˆ-trans (â‰ˆ-J (â‡’-â‰ˆ dâ‡’d') â‰ˆ-refl) â‰ˆ-Î¹
â‡’-â‰ˆ (â‡’-ift aâ‡’a') = â‰ˆ-trans (â‰ˆ-if â‰ˆ-refl (â‡’-â‰ˆ aâ‡’a') â‰ˆ-refl) â‰ˆ-ift
â‡’-â‰ˆ (â‡’-iff câ‡’c') = â‰ˆ-trans (â‰ˆ-if â‰ˆ-refl â‰ˆ-refl (â‡’-â‰ˆ câ‡’c')) â‰ˆ-iff
â‡’-â‰ˆ (â‡’-var s) = â‰ˆ-refl
â‡’-â‰ˆ (â‡’-ð’° k) = â‰ˆ-refl
â‡’-â‰ˆ (â‡’-Î  aâ‡’a' bâ‡’b') = â‰ˆ-Î  (â‡’-â‰ˆ aâ‡’a') (â‡’-â‰ˆ bâ‡’b')
â‡’-â‰ˆ (â‡’-Î»áµˆ bâ‡’b') = â‰ˆ-Î»áµˆ (â‡’-â‰ˆ bâ‡’b')
â‡’-â‰ˆ (â‡’-$áµˆ bâ‡’b' aâ‡’a') = â‰ˆ-$áµˆ (â‡’-â‰ˆ bâ‡’b') (â‡’-â‰ˆ aâ‡’a')
â‡’-â‰ˆ â‡’-mty = â‰ˆ-refl
â‡’-â‰ˆ (â‡’-abs bâ‡’b') = â‰ˆ-abs (â‡’-â‰ˆ bâ‡’b')
â‡’-â‰ˆ (â‡’-eq Aâ‡’A' aâ‡’a' bâ‡’b') = â‰ˆ-eq (â‡’-â‰ˆ Aâ‡’A') (â‡’-â‰ˆ aâ‡’a') (â‡’-â‰ˆ bâ‡’b')
â‡’-â‰ˆ â‡’-rfl = â‰ˆ-refl
â‡’-â‰ˆ (â‡’-J dâ‡’d' pâ‡’p') = â‰ˆ-J (â‡’-â‰ˆ dâ‡’d') (â‡’-â‰ˆ pâ‡’p')
â‡’-â‰ˆ â‡’-ð”¹ = â‰ˆ-refl
â‡’-â‰ˆ â‡’-true = â‰ˆ-refl
â‡’-â‰ˆ â‡’-false = â‰ˆ-refl
â‡’-â‰ˆ (â‡’-if bâ‡’b' aâ‡’a' câ‡’c') = â‰ˆ-if (â‡’-â‰ˆ bâ‡’b') (â‡’-â‰ˆ aâ‡’a') (â‡’-â‰ˆ câ‡’c')

â‡’â‹†-â‰ˆ : âˆ€ {a b} â†’ a â‡’â‹† b â†’ a â‰ˆ b
â‡’â‹†-â‰ˆ (â‡’â‹†-refl a) = â‰ˆ-refl
â‡’â‹†-â‰ˆ (â‡’â‹†-trans aâ‡’b bâ‡’â‹†c) = â‰ˆ-trans (â‡’-â‰ˆ aâ‡’b) (â‡’â‹†-â‰ˆ bâ‡’â‹†c)

â‡”-â‰ˆ : âˆ€ {a b} â†’ a â‡” b â†’ a â‰ˆ b
â‡”-â‰ˆ (_ , aâ‡’â‹†c , bâ‡’â‹†c) = â‰ˆ-trans (â‡’â‹†-â‰ˆ aâ‡’â‹†c) (â‰ˆ-sym (â‡’â‹†-â‰ˆ bâ‡’â‹†c))

â‰ˆ-â‡” : âˆ€ {a b} â†’ a â‰ˆ b â†’ a â‡” b
â‰ˆ-â‡” â‰ˆ-refl = â‡”-refl
â‰ˆ-â‡” (â‰ˆ-sym bâ‰ˆa) = â‡”-sym (â‰ˆ-â‡” bâ‰ˆa)
â‰ˆ-â‡” (â‰ˆ-trans aâ‰ˆb bâ‰ˆc) = â‡”-trans (â‰ˆ-â‡” aâ‰ˆb) (â‰ˆ-â‡” bâ‰ˆc)
â‰ˆ-â‡” â‰ˆ-Î² = â‡’-â‡” (â‡’-Î² (â‡’-refl _) (â‡’-refl _))
â‰ˆ-â‡” â‰ˆ-Î¹ = â‡’-â‡” (â‡’-Î¹ (â‡’-refl _))
â‰ˆ-â‡” â‰ˆ-ift = â‡’-â‡” (â‡’-ift (â‡’-refl _))
â‰ˆ-â‡” â‰ˆ-iff = â‡’-â‡” (â‡’-iff (â‡’-refl _))
â‰ˆ-â‡” (â‰ˆ-Î  aâ‰ˆa' bâ‰ˆb') = â‡”-Î  (â‰ˆ-â‡” aâ‰ˆa') (â‰ˆ-â‡” bâ‰ˆb')
â‰ˆ-â‡” (â‰ˆ-Î»áµˆ bâ‰ˆb') = â‡”-Î»áµˆ (â‰ˆ-â‡” bâ‰ˆb')
â‰ˆ-â‡” (â‰ˆ-$áµˆ bâ‰ˆb' aâ‰ˆa') = â‡”-$áµˆ (â‰ˆ-â‡” bâ‰ˆb') (â‰ˆ-â‡” aâ‰ˆa')
â‰ˆ-â‡” (â‰ˆ-abs bâ‰ˆb') = â‡”-abs (â‰ˆ-â‡” bâ‰ˆb')
â‰ˆ-â‡” (â‰ˆ-eq Aâ‰ˆA' aâ‰ˆa' bâ‰ˆb') = â‡”-eq (â‰ˆ-â‡” Aâ‰ˆA') (â‰ˆ-â‡” aâ‰ˆa') (â‰ˆ-â‡” bâ‰ˆb')
â‰ˆ-â‡” (â‰ˆ-J dâ‰ˆd' pâ‰ˆp') = â‡”-J (â‰ˆ-â‡” dâ‰ˆd') (â‰ˆ-â‡” pâ‰ˆp')
â‰ˆ-â‡” (â‰ˆ-if bâ‰ˆb' aâ‰ˆa' câ‰ˆc') = â‡”-if (â‰ˆ-â‡” bâ‰ˆb') (â‰ˆ-â‡” aâ‰ˆa') (â‰ˆ-â‡” câ‰ˆc')

{--------------------------------------------------
  Context well-formedness and term well-typedness
--------------------------------------------------}

infix 10 âŠ¢_
data âŠ¢_ : Ctxt â†’ Set
data _âŠ¢_â¦‚_ (Î“ : Ctxt) : Term â†’ Term â†’ Set

data âŠ¢_ where
  âŠ¢âˆ™ : âŠ¢ âˆ™
  âŠ¢âˆ· : âˆ€ {Î“ A k} â†’
       âŠ¢ Î“ â†’
       Î“ âŠ¢ A â¦‚ ð’° k â†’
       ---------------
       âŠ¢ Î“ âˆ· A

data _âŠ¢_â¦‚_ Î“ where
  âŠ¢var    : âˆ€ {x A} â†’
            âŠ¢ Î“ â†’
            x â¦‚ A âˆˆ Î“ â†’
            -------------
            Î“ âŠ¢ var x â¦‚ A
  âŠ¢ð’°      : âˆ€ {j k} â†’ âŠ¢ Î“ â†’
            j < k â†’
            ---------------
            Î“ âŠ¢ ð’° j â¦‚ ð’° k
  âŠ¢Î       : âˆ€ {A B k} â†’
            Î“ âŠ¢ A â¦‚ ð’° k â†’
            Î“ âˆ· A âŠ¢ B â¦‚ ð’° k â†’
            -----------------
            Î“ âŠ¢ Î  A B â¦‚ ð’° k
  âŠ¢Î»áµˆ     : âˆ€ {A B b k} â†’
            Î“ âŠ¢ Î  A B â¦‚ ð’° k â†’
            Î“ âˆ· A âŠ¢ b â¦‚ B â†’
            ----------------
            Î“ âŠ¢ Î»áµˆ b â¦‚ Î  A B
  âŠ¢$áµˆ     : âˆ€ {A B b a} â†’
            Î“ âŠ¢ b â¦‚ Î  A B â†’
            Î“ âŠ¢ a â¦‚ A â†’
            -------------------------------
            Î“ âŠ¢ $áµˆ b a â¦‚ subst (a +: var) B
  âŠ¢mty    : âˆ€ {k} â†’ âŠ¢ Î“ â†’
            ---------------
            Î“ âŠ¢ mty â¦‚ ð’° k
  âŠ¢abs    : âˆ€ {A b k} â†’
            Î“ âŠ¢ A â¦‚ ð’° k â†’
            Î“ âŠ¢ b â¦‚ mty â†’
            -------------
            Î“ âŠ¢ abs b â¦‚ A
  âŠ¢eq     : âˆ€ {A a b k} â†’
            Î“ âŠ¢ A â¦‚ ð’° k â†’
            Î“ âŠ¢ a â¦‚ A â†’
            Î“ âŠ¢ b â¦‚ A â†’
            -------------------
            Î“ âŠ¢ eq A a b â¦‚ ð’° k
  âŠ¢refl   : âˆ€ {A a} â†’
            Î“ âŠ¢ a â¦‚ A â†’
            -------------------
            Î“ âŠ¢ refl â¦‚ eq A a a
  âŠ¢J      : âˆ€ {A a b p d B k} â†’
            Î“ âŠ¢ p â¦‚ eq A a b â†’
            Î“ âˆ· A âˆ· eq (rename suc A) (rename suc a) (var 0) âŠ¢ B â¦‚ ð’° k â†’
            Î“ âŠ¢ d â¦‚ subst (refl +: a +: var) B â†’
            ------------------------------------
            Î“ âŠ¢ J d p â¦‚ subst (p +: b +: var) B
  âŠ¢ð”¹      : âˆ€ {k} â†’ âŠ¢ Î“ â†’
            -------------
            Î“ âŠ¢ ð”¹ â¦‚ ð’° k
  âŠ¢true   : âŠ¢ Î“ â†’
            ------------
            Î“ âŠ¢ true â¦‚ ð”¹
  âŠ¢false  : âŠ¢ Î“ â†’
            -------------
            Î“ âŠ¢ false â¦‚ ð”¹
  âŠ¢if     : âˆ€ {A b a c k} â†’
            Î“ âˆ· ð”¹ âŠ¢ A â¦‚ ð’° k â†’
            Î“ âŠ¢ b â¦‚ ð”¹ â†’
            Î“ âŠ¢ a â¦‚ subst (true +: var) A â†’
            Î“ âŠ¢ c â¦‚ subst (false +: var) A â†’
            ---------------------------------
            Î“ âŠ¢ if b a c â¦‚ subst (b +: var) A
  âŠ¢â‰ˆ      : âˆ€ {A B a k} â†’
            A â‰ˆ B â†’
            Î“ âŠ¢ a â¦‚ A â†’
            Î“ âŠ¢ B â¦‚ ð’° k â†’
            -------------
            Î“ âŠ¢ a â¦‚ B